#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_TCS34725.h>
#include <SoftwareSerial.h>

// Color Sensor
Adafruit_TCS34725 colorSensor = Adafruit_TCS34725(TCS34725_INTEGRATIONTIME_50MS, TCS34725_GAIN_4X);

// OLED Display
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// ESP8266
SoftwareSerial esp8266(2, 3);  // RX, TX

// Line Follower Pins
const int leftMotor1 = 4;
const int leftMotor2 = 5;
const int rightMotor1 = 6;
const int rightMotor2 = 7;

// Color Detection Thresholds (adjust as needed)
const int redThreshold = 100;  // Adjust this value based on your color sensor readings

void setup() {
  Serial.begin(9600);
  esp8266.begin(9600);

  // Initialize color sensor
  if (!colorSensor.begin()) {
    Serial.println("Color Sensor not found. Please check your connections.");
    while (1);
  }

  // Initialize OLED display
  if(!display.begin(SSD1306_I2C_ADDRESS, 4, 5, RST)) {
    Serial.println(F("SSD1306 allocation failed"));
    for(;;);
  }
  display.display();
  delay(2000);
  display.clearDisplay();
  
  // Motor pins setup
  pinMode(leftMotor1, OUTPUT);
  pinMode(leftMotor2, OUTPUT);
  pinMode(rightMotor1, OUTPUT);
  pinMode(rightMotor2, OUTPUT);
}

void loop() {
  // Read color sensor values
  uint16_t clear, red, green, blue;
  colorSensor.getRawData(&red, &green, &blue, &clear);

  // Check if red color is detected
  if (red > redThreshold) {
    stopMotors();
    displayRedOnScreen();
    sendCommandToOtherRobot("Red");
  } else {
    // Continue moving forward
    moveForward();
    display.clearDisplay();
  }
}

void moveForward() {
  digitalWrite(leftMotor1, HIGH);
  digitalWrite(leftMotor2, LOW);
  digitalWrite(rightMotor1, HIGH);
  digitalWrite(rightMotor2, LOW);
}

void stopMotors() {
  digitalWrite(leftMotor1, LOW);
  digitalWrite(leftMotor2, LOW);
  digitalWrite(rightMotor1, LOW);
  digitalWrite(rightMotor2, LOW);
}

void displayRedOnScreen() {
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.print("Color Detected:");
  display.setCursor(0, 10);
  display.print("Red");
  display.display();
}

void sendCommandToOtherRobot(String command) {
  esp8266.print(command);
}
